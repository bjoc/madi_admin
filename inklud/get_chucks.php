<?php	require('connect.php');	require("class.phpmailer.php");  	require("class.smtp.php");  	$PHPData = $_REQUEST["PHPData"];		// módok	// ["NG", site, sender_id, datetime, news_id, 0		] News+objektumok -> news group-okhoz	pl. hírlevél	// ["NU", site, sender_id, datetime, news_id, user_id	] News+objektumok -> user_id-ra 		pl. hírlevél előnézet	// ["TU", site, sender_id, datetime, template_id, user_id] Template -> user_id-ra 				pl. lejelentkezés, jelszó változtatás! 	// ["TM", site, sender_id, datetime, template_id, mail] 	Template -> mailre					pl. feliratkozás 	// ["OU", site, sender_id, datetime, template_id, user_id, 'obj1, obj2, ...']] 	Template+object -> user_id-ra 		pl. ?  	// ["OM", site, sender_id, datetime, template_id, mail, 'obj1, obj2, ...'] 	Template+object -> mailre			pl. emlékeztető 	// ["BB", site, sender_id, datetime, template_id, bid_id	] Bid+objektumok -> user_id-ra  		$mode = 		$PHPData[0];	$NTO = 			substr($mode, 0, 1); // news, template, object, bid	$GUM = 			substr($mode, 1, 1); // group, userid, mail, bid	$siteid =		$PHPData[1];	$senderid =		$PHPData[2];	$datetime =		$PHPData[3];	$newsid =		$PHPData[4];	$templateid =	$PHPData[4];	$bidid =		$PHPData[5];	$userid =		$PHPData[5];	$usermail =		$PHPData[5];	$obj_in =		$PHPData[6];	// site paraméterek	$querysite = "	SELECT Site_Name, Site_URL, Site_ImagesDir, Site_SubDir, Site_ReplyMail, Site_Images, 	Site_SMTPAddr, Site_SMTPUsername, Site_SMTPPassword, Site_SMTPPort, Site_SMTPAuth FROM Site WHERE id = $siteid";	$resultsite = mysqli_query($con, $querysite); $rowsite = mysqli_fetch_assoc($resultsite);	$sitename = $rowsite['Site_Name'];	$siteurl = $rowsite['Site_URL'];	$sitesubdir = $rowsite['Site_SubDir'];	$sitemail = $rowsite['Site_ReplyMail'];	$siteimagesdir = $rowsite['Site_ImagesDir'];	$siteimages = $rowsite['Site_Images'];	$siteSMTPAddr = $rowsite['Site_SMTPAddr'];	$siteSMTPUsername = $rowsite['Site_SMTPUsername'];	$siteSMTPPassword = $rowsite['Site_SMTPPassword'];	$siteSMTPPort = $rowsite['Site_SMTPPort'];	$siteSMTPAuth = $rowsite['Site_SMTPAuth'];	 	$mail = new PHPMailer();   	$mail->Host 	= $siteSMTPAddr; 	$mail->Port 	= $siteSMTPPort;	if ($siteSMTPAuth == 1) {		$mail->Username = $siteSMTPUsername;		$mail->Password = $siteSMTPPassword;		$mail->SMTPSecure = 'ssl';  		$mail->SMTPAuth = true;			} else {		$mail->Username = "";		$mail->Password = "";		$mail->SMTPAuth = false;			}	$mail->CharSet = 'UTF-8';	$mail->IsSMTP();	$mail->IsHTML(true);	$mail->WordWrap = 50;			// küldő user	$query = "SELECT Client_Username, Client_ForName, Client_SurName, Client_Company, Client_Email FROM Client WHERE id = $senderid";	$result = mysqli_query($con, $query); $row = mysqli_fetch_assoc($result);	$sendername = $row['Client_SurName'] . ' ' . $row['Client_ForName'];	$sendermail = $row['Client_Email'];	// template paraméterek	$query = "	SELECT Template_Subject, Template_Header, Template_Body, Template_Footer, Template_ReplyMail, Template_ReplyMailDesc, Template_CanReply ";	if ($NTO == "N") 		$query .= "FROM Template INNER JOIN News ON News_Template_id = Template.id WHERE News.id = $newsid";	else // T, O		$query .= "FROM Template WHERE Template.id = $templateid";	$result = mysqli_query($con, $query); $row = mysqli_fetch_assoc($result);	$oriheader = htmlspecialchars_decode($row['Template_Header']);	$oribody 	= htmlspecialchars_decode($row['Template_Body']);	$orifooter = htmlspecialchars_decode($row['Template_Footer']);	$orisubject = $row['Template_Subject'];	$orireply = $row['Template_ReplyMail'];	$orireplydesc = $row['Template_ReplyMailDesc'];		// "B" esetén ajánlat paraméterek	$arrivedate = "";	$staynights = "";	$adults = "";	$persons = "";	$children = "";	$childage = "";	$offerdate = "";	$offercomment = "";		if ($NTO == "B") {		$query = "	SELECT Bid_ArriveDate, Bid_StayNights, Bid_Adults, Bid_Children, Bid_ChildrenAge, Bid_Created, Bid_Comment, Bid_Client_id FROM Bid WHERE Bid.id = $bidid";		$result = mysqli_query($con, $query); $row = mysqli_fetch_assoc($result);		$arrivedate = $row['Bid_ArriveDate'];		$staynights = $row['Bid_StayNights'];		$adults = $row['Bid_Adults'];		$children = $row['Bid_Children'];		$persons = $adults + $children;		$childage = $row['Bid_ChildrenAge'];		$offerdate = $row['Bid_Created'];		$offercomment = $row['Bid_Comment'];		$biduserid = $row['Bid_Client_id']; // ezt kapja a következő query	} 		// csatolt objektumok 	$objs = ""; 	// ...ajánlat esetén	if ($NTO == "B") {				$query = "	SELECT  Object.id, Object_Name, Object_List_Image_Small, Object_Short_Description, fromdate, todate FROM Object  						INNER JOIN Bid_Objects ON Bid_Objects.Object_id = Object.id						WHERE Bid_Objects.Bid_id = $bidid						ORDER BY Object.Object_Date_Available DESC";			$result = mysqli_query($con, $query);			while($row = mysqli_fetch_row($result)) {				$objectid = $row[0];				$objectname = $row[1];				$objectimg = $row[2];				$objectdesc = trim(htmlspecialchars_decode($row[3]));				$objectdate = $row[4] . (($row[5] == "" OR $row[5] == $row[4])? "" : " - ".$row[5]);				$img = $siteimages.$siteimagesdir.$objectimg;				$objs .= "<b>$objectname</b><br>".($objectdate ? "$objectdate<br>" : "")."<br>$objectdesc<br><br>";			}	}	// ...egyéb esetben	if ($NTO == "N" || $NTO == "O") {			$query = "	SELECT  Object.id, Object_Name, Object_List_Image_Small, Object_Short_Description, Object_Date_Available						FROM Object ";			if ($NTO == "N") 				$query .= "	 						INNER JOIN News_Objects ON News_Objects.Object_id = Object.id						WHERE News_id = $newsid						ORDER BY Object.Object_Date_Available DESC";			if ($NTO == "O") {				$query .= " WHERE Object_id IN (";						for ($i=0;$i<count($obj_in);$i++) {						$query .= $obj_in[$i];						if ($i<count($obj_in)-1) $query .= ","; 					} 				$query .= " ) ";				}			$result = mysqli_query($con, $query);			while($row = mysqli_fetch_row($result)) {				$objectid = $row[0];				$objectname = $row[1];				$objectimg = $row[2];				$objectdesc = htmlspecialchars_decode($row[3]);				$objectdate = $row[4];				$img = $siteurl.$siteimagesdir.$objectimg;				$objs .= "				<a href='$siteurl'>				<div style='display:table;cursor:pointer;color:black;'>					<div style='width:25%;display:table-cell;background-color: 27aae1;vertical-align:middle;'><img style='max-width:100%;' src='$img'></div>					<div style='width:70%;display:table-cell;background-color: fdfdfd;vertical-align:middle;padding-left:20px;line-height:1.5;'>						<b><big>$objectname</big></b><br><br>						$objectdate<br><br>						$objectdesc					</div>				</div></a><br><br>";			}	} 		// user(ek)		if ($GUM == "B") $query = "SELECT Client_Username, Client_ForName, Client_SurName, Client_Company, Client_Email, Client_Password, Client_NewPassword, Client_Phone, Client_Postcode, Client_City, Client_Address, Country_Name FROM Client INNER JOIN Country ON Country.id = Client.Client_Country_id WHERE Client.id = " . $biduserid;				if ($GUM == "M") $query = "SELECT '$usermail' AS Client_Email";		if ($GUM == "U") $query = "SELECT Client_Username, Client_ForName, Client_SurName, Client_Company, Client_Email, Client_Password FROM Client WHERE id = $userid";		if ($GUM == "G") $query = "SELECT DISTINCT Client_Username, Client_ForName, Client_SurName, Client_Company, Client_Email 		FROM Client 		INNER JOIN Client_MailGroups 	ON Client_MailGroups.Client_id = Client.id		INNER JOIN News_MailGroups 		ON News_MailGroups.Client_MailGroup_id = Client_MailGroups.Client_MailGroup_id		INNER JOIN News 				ON News.id = News_MailGroups.News_id		WHERE Client.Client_Status = 1 AND News.id = $newsid";			$result = mysqli_query($con, $query); 		while ($row = mysqli_fetch_assoc($result)) {			$username = $row['Client_Username'];			$forname = $row['Client_ForName'];			$surname = $row['Client_SurName'];			$compname = $row['Client_Company'];			$usermail = $row['Client_Email'];			$userpw = 	($GUM == "U" ? $row['Client_Password'] : '');			$mail->AddAddress($usermail, ($forname == "" ? $compname : $surname . ' ' . $forname));				//beágyazott változók						$rplc = [			"#sendermail", $sendermail,			"#sendername", $sendername,			"#sitemail", $sitemail,			"#sitename", $sitename,			"#userid", $username,			"#userpw", $userpw,			"#usermail", $usermail,			"#username", ($forname == "" ? $compname : $surname . ' ' . $forname),			"#datetime", $datetime,			"#newsletter_link_on" , $siteurl . $sitesubdir . "/inklud/newslettersubscribe.php?s=$siteid&m=$usermail&c=".hash('sha512',$usermail.'DorZal'),						"#newsletter_link_off" , $siteurl . $sitesubdir . "/inklud/newsletterunsubscribe.php?s=$siteid&m=$usermail&c=".hash('sha512',$usermail.'DorZal'),						"#newpassword_link" , $siteurl . $sitesubdir . "/inklud/newpasswordsubscribe.php?s=$siteid&m=$usermail&c=".hash('sha512',$usermail.'DorZal')."&p=".hash('sha512',$temppw.'DorZal'),			"#userphone", $userphone,			"#useraddress", $useraddress,			"#offer_objects", $objs,			"#arrivedate", $arrivedate,			"#staynights", $staynights,			"#adults", $adults,			"#persons", $persons,			"#children", $children,			"#childage", $childage,			"#offerdate", $offerdate,			"#offercomment", $offercomment,			"#usercountry", $usercountry						];			$reply 		= Macro($rplc, $orireply);			$replydesc 	= Macro($rplc, $orireplydesc);			$subject	= Macro($rplc, $orisubject);			$header		= Macro($rplc, $oriheader);			$body		= Macro($rplc, $oribody);			$footer		= Macro($rplc, $orifooter);			$mail->From     = $reply;			$mail->FromName = $replydesc;			if ($row['Template_CanReply'])				$mail->AddReplyTo($reply,$replydesc);			else				$mail->AddReplyTo("noreply@","");			$mail->Subject = $subject;			$mail->Body = $header .'<br>'; 			$mail->Body .= $body.'<br>'; 			if ($NTO != "B") $mail->Body .= $objs.'<br>'; 			$mail->Body .= $footer; 			/*			$mail->WordWrap = 50;                              // Sortörés állítása  			$mail->AddAttachment("/var/tmp/file.tar.gz");   // Csatolás  			$mail->AddAttachment("/tmp/kep.jpg", "kep.jpg"); // Csatolás más néven  */					if (!$mail->Send()) {  			  echo "A levél nem került elküldésre<br>";  			  echo "A felmerült hiba: " . $mail->ErrorInfo;  			  exit;  			}  else echo "OK";		} 	mysqli_close($con);  	 	function Macro($mrplc, $mstr) {	 	for ($i=0; $i<count($mrplc);$i++) {			$mstr = str_replace($mrplc[$i],$mrplc[$i+1],$mstr);		 	$i++;	 	}	 	return $mstr; 	}